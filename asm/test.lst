                      ; BUILD:        asm6809 -H -9 test.asm -o test.hex              
                                      
0010                                  org             $0010
                      ; EXEC_VECTOR
0010  2008            exe_vect        fdb             start
                      
                      
                      
                      
0012                                  INCLUDE "mem_map.asm"
                      ;  **********************************************
                      ;  * Allocated 64k Memory Mapped System Symbols *
                      ;  **********************************************
                      
                      
                      ;  Zero-Page Kernal Variables:
0010                  SYSTEM_VARS     equ     $0010   ; start kernal vectors and variables
                      
                      ;  Stack Frames:
0100                  U_STK_BTM       equ     $0100   ; 256 bytes default user stack space
0200                  U_STK_TOP       equ     $0200   ; User Stack initial address
0200                  S_STK_BTM       equ     $0200   ; 512 bytes default system stack space
0400                  S_STK_TOP       equ     $0400   ; System Stack initial address
                      
                      ;  Video Buffer Memory (target = $0400):
0400                  VIDEO_START     equ     $0400   ; Start of 5KB Video Buffer Memory
17FF                  VIDEO_END       equ     $17ff   ; Last Byte of 5KB Video Buffer Memory
                      
                      ;  Graphics Hardware Registers:
1800                  GFX_BEGIN       equ     $1800   ; start of graphics hardware registers
1800                  CPU_CLK_DIV     equ     $1800   ; (Byte) 2 Mhz CPU Clock Divider:
                                                      ;      bit 7:   1280/2560 = 1000.0 Khz
                                                      ;      bit 6:  640/2560 =  500.0 Khz
                                                      ;      bit 5:    320/2560 =  250.0 Khz
                                                      ;      bit 4:  160/2560 =  125.0 Khz
                                                      ;      bit 3:   80/2560 =   62.5 Khz
                                                      ;      bit 2:   40/2560 =   31.25 Khz
                                                      ;      bit 2:   20/2560 =   15.625 Khz
                                                      ;      bit 2:   10/2560 =    7.8125 Khz
1801                  GFX_FLAGS       equ     $1801   ; (Byte) gfx system flags:
                                                      ;      bit 7: VSYNC
                                                      ;      bit 6: backbuffer enable
                                                      ;      bit 5: swap backbuffers (on write)
                                                      ;      bit 4: reserved
                                                      ;      bits 2-3 = 'Background' graphics modes (20KB buffer)
                                                      ;          0) NONE (forced black background)
                                                      ;          1) Tiled 16x16 mode
                                                      ;          2) Overscan Tile 16x16 mode
                                                      ;          3) 128x80 x 256-Colors
                                                      ;      bits 0-1 = 'Foreground' graphics modes (5KB buffer)
                                                      ;          0) 256x160 x 2-Color (with disable flag)
                                                      ;          1) Glyph Mode (32x20 text)
                                                      ;          2) Glyph Mode (64x40 text)
                                                      ;          3) 128x80 x 16-Color
1802                  GFX_AUX equ     $1802   ; (Byte) gfx auxillary/emulation flags:
                                                      ;      bit 7: 1:fullscreen / 0:windowed
                                                      ;      bit 6: reserved
                                                      ;      bit 5: reserved
                                                      ;      bit 4: reserved
                                                      ;      bit 3: reserved
                                                      ;      bit 0-2: monitor display index (0-7)
1803                  GFX_TIMING_W    equ     $1803   ; (Word) horizontal timing
1805                  GFX_TIMING_H    equ     $1805   ; (Word) vertical timing
1807                  GFX_PAL_INDX    equ     $1807   ; (Byte) gfx palette index (0-15)
1808                  GFX_PAL_DATA    equ     $1808   ; (Word) gfx palette color bits RGBA4444
                      
                      ;  Paged Foreground Graphics Mode Hardware Registers:
180A                  GFX_FG_BEGIN    equ     $180a   ; start of paged foreground gfxmode registers
180A                  GFX_FG_WDTH     equ     $180a   ; (Byte) Foreground Unit Width-1
180B                  GFX_FG_HGHT     equ     $180b   ; (Byte) Foreground Unit Height-1
180B                  GFX_FG_END      equ     $180b   ; end of paged foreground gfxmode registers
                      
                      ;  Paged Background Graphics Mode Hardware Registers:
180C                  GFX_BG_BEGIN    equ     $180c   ; start of paged background gfxmode registers
180C                  GFX_EXT_ADDR    equ     $180c   ; (Word) 20K extended graphics addresses
180E                  GFX_EXT_DATA    equ     $180e   ; (Byte) 20K extended graphics RAM data
180E                  GFX_BG_END      equ     $180e   ; end of paged background gfxmode registers
                      
                      ;  Mouse Cursor Hardware Registers:
180F                  CSR_BEGIN       equ     $180f   ; start of mouse cursor hardware registers
180F                  CSR_XPOS        equ     $180f   ; (Word) horizontal mouse cursor coordinate
1811                  CSR_YPOS        equ     $1811   ; (Word) vertical mouse cursor coordinate
1813                  CSR_XOFS        equ     $1813   ; (Byte) horizontal mouse cursor offset
1814                  CSR_YOFS        equ     $1814   ; (Byte) vertical mouse cursor offset
1815                  CSR_SIZE        equ     $1815   ; (Byte) cursor size (0-15) 0:off
1816                  CSR_SCROLL      equ     $1816   ; (Signed) MouseWheel Scroll: -1, 0, 1
1817                  CSR_FLAGS       equ     $1817   ; (Byte) mouse button flags:
                                                      ;      bits 0-5: button states
                                                      ;      bits 6-7: number of clicks
1818                  CSR_PAL_INDX    equ     $1818   ; (Byte) mouse cursor color palette index (0-15)
1819                  CSR_PAL_DATA    equ     $1819   ; (Word) mouse cursor color palette data RGBA4444
181B                  CSR_BMP_INDX    equ     $181b   ; (Byte) mouse cursor bitmap pixel offset
181C                  CSR_BMP_DATA    equ     $181c   ; (Byte) mouse cursor bitmap pixel index color
181C                  CSR_END equ     $181c   ; end of mouse cursor hardware registers
                      
                      ;  Debugger Hardware Registers:
181D                  DBG_BEGIN       equ     $181d   ; Start of Debugger Hardware Registers
181D                  DBG_BRK_ADDR    equ     $181d   ; (Word) Address of current breakpoint
181F                  DBG_FLAGS       equ     $181f   ; (Byte) Debug Specific Hardware Flags
                                                      ;      bit 7: Debug Enable
                                                      ;      bit 6: Single Step Enable
                                                      ;      bit 5: clear all breakpoints
                                                      ;      bit 4: Toggle Breakpoint at DEBUG_BRK_ADDRESS
                                                      ;      bit 3: FIRQ  (on low to high edge)
                                                      ;      bit 2: IRQ   (on low to high edge)
                                                      ;      bit 1: NMI   (on low to high edge)
                                                      ;      bit 0: RESET (on low to high edge)
181F                  DBG_END equ     $181f   ; End of the Debugger Hardware Registers
                      
                      
1820                  GFX_END equ     $1820   ; end of the GFX Hardware Registers
                      
                      ;  File I/O Hardware Registers:
1820                  FIO_BEGIN       equ     $1820   ; start of file i/o hardware registers
1820                  FIO_ERR_FLAGS   equ     $1820   ; (Byte) file i/o system flags:
                                                      ;      bit 7:   file not found
                                                      ;      bit 6:  end of file
                                                      ;      bit 5:   buffer overrun
                                                      ;      bit 4: wrong file type
                                                      ;      bit 3: directory not found
                                                      ;      bit 0-2: not yet assigned
1821                  FIO_COMMAND     equ     $1821   ; (Byte) OnWrite - command to execute
                                                      ;      $00 = Reset/Null
                                                      ;      $01 = Open/Create Binary File for Reading
                                                      ;      $02 = Open/Create Binary File for Writing
                                                      ;      $03 = Open/Create Binary File for Append
                                                      ;      $04 = Close File
                                                      ;      $05 = Read Byte
                                                      ;      $06 = Write Byte
                                                      ;      $07 = Load Hex Format File
                                                      ;      $08 = Write Hex Format Line
                                                      ;      $09 = Get File Length (FIO_BFRLEN = file length
                                                      ;      $0A = Load Binary File (read into FIO_BFROFS - FIO_BFROFS+FIO_BFRLEN)
                                                      ;      $0B = Save Binary File (wrote from FIO_BFROFS to FIO_BFROFS+FIO_BFRLEN)
                                                      ;      $0C = (not yet designed) List Directory
                                                      ;      $0D = Make Directory
                                                      ;      $0E = Change Directory
                                                      ;      $0F = Rename Directory
                                                      ;      $10 = Remove Directory
                                                      ;      $11 = Delete File
                                                      ;      $12 = Rename file
                                                      ;      $13 = Copy File
                                                      ;      $14 = Seek Start
                                                      ;      $15 = Seek Current
                                                      ;      $16 = Seek End
                                                      ;      $17 = SYSTEM: Shutdown
1822                  FIO_HANDLE      equ     $1822   ; (Byte) file handle or ZERO
1823                  FIO_BFROFS      equ     $1823   ; (Word) start of I/O buffer
1824                  FIO_BFRLEN      equ     $1824   ; (Word) length of I/O buffer
1826                  FIO_SEEKOFS     equ     $1826   ; (Word) seek offset
1828                  FIO_RET_COUNT   equ     $1828   ; (Byte) number of return entries
1829                  FIO_RET_INDEX   equ     $1829   ; (Byte) command return index
182A                  FIO_RET_BUFFER  equ     $182a   ; (Char Array 256) paged return buffer
192A                  FIO_FILEPATH    equ     $192a   ; (Char Array 256) file path and argument buffer
1A2A                  FIO_END equ     $1a2a   ; end of file i/o hardware registers
                      
                      ;  Keyboard Hardware Registers:
1A2B                  KEY_BEGIN       equ     $1a2b   ; start of keyboard hardware registers
1A2B                  CHAR_Q_LEN      equ     $1a2b   ; (char) # of characters waiting in queue       (Read Only)
1A2C                  CHAR_SCAN       equ     $1a2c   ; read next character in queue       (not popped when read)
1A2D                  CHAR_POP        equ     $1a2d   ; (char) next character waiting in queue (popped when read)
1A2E                  XKEY_BUFFER     equ     $1a2e   ; (128 bits) 16 bytes for XK_KEY data buffer    (Read Only)
1A3E                  EDT_BFR_CSR     equ     $1a3e   ; (Byte) cursor position within edit buffer    (Read/Write)
1A3F                  EDT_BUFFER      equ     $1a3f   ; (256 Bytes) line editing character buffer    (Read/Write)
1B3F                  KEY_END equ     $1b3f   ; end of keyboard hardware registers
                      
                      ;  Reserved Hardware:
1B40                  RESERVED_HDW    equ     $1b40   ; Reserved 1211 bytes ($1B40 - $1FFB)
                      
                      ;  Memory Bank Selects (16MB):
1FFC                  RAMBANK_SEL_1   equ     $1ffc   ; (Word)Indexes 65536 x 8kb banks
1FFE                  RAMBANK_SEL_2   equ     $1ffe   ; (Word)Indexes 65536 x 8kb banks
                      
                      ;  Standard Usable (from FAST static 32KB) RAM:
2000                  RAM_START       equ     $2000   ; Begin System RAM (32k)
9FFF                  RAM_END equ     $9fff   ; End System RAM
                      
                      ;  Switchable RAM Banks (from SLOW external serial 16MB RAM chip):
A000                  RAM_BANK_1      equ     $a000   ; switched 8KB ram bank 1
C000                  RAM_BANK_2      equ     $c000   ; switched 8KB ram bank 2
                      
                      ;  Bios Kernal ROM:
E000                  BIOS_ROM        equ     $e000   ; Begin BIOS Kernal ROM (8KB)
                      
2000                                  ORG             $2000
                      
2000  00              var_ch                  fcb             $00
2001  00              var_at                  fcb             $00
2002  00              var_count               fcb             $00
2003  FF              var_csr                 fcb             $ff
0020                  num_cycles              equ             $20
2004  00              var_cycle               fcb             $00
2005  00              var_mode_index  fcb             $00
2006  0000            var_mouse_color fdb             $0000
                      
2008                  start
                      
                                              ; TESTING: fill the first 256 bytes of screen ram 
                                              ;               with ascending values to display
                                              
2008  8620                                    lda             #num_cycles             ; initially clear the cycle variable
200A  B72004                                  sta             var_cycle
                      
                                              ; SAVE THE MOUSE CURSOR COLOR
200D  8604                                    lda             #4
200F  B71818                                  sta             CSR_PAL_INDX
2012  FC1819                                  ldd             CSR_PAL_DATA
2015  FD2006                                  std             var_mouse_color
                      
                      ;                       ; enable backbuffer mode
                      ;                       lda             GFX_FLAGS
                      ;                       ora             #$40
                      ;                       sta             GFX_FLAGS
                      
                                              ; set up the initial graphics mode 
2018  7F2005                                  clr             var_mode_index  ; start with index 0
201B  8E20E5                                  ldx             #mode_data
201E  B61801                                  lda             GFX_FLAGS
2021  84F0                                    anda    #$f0
2023  AA84                                    ora             ,x
2025  B71801                                  sta             GFX_FLAGS
                      
                                              ; fill the background buffer with incrementing values
2028  8E0000                                  ldx             #0
202B                  1
202B  BF180C                                  stx             GFX_EXT_ADDR
202E  B7180E                                  sta             GFX_EXT_DATA
2031  4C                                      inca
2032  81FF                                    cmpa    #$ff
2034  2601                                    bne             2f
2036  4F                                      clra
2037                  2
2037  3001                                    leax    1,x
2039  8C2800                                  cmpx    #$2800
203C  26ED                                    bne             1b
                      
                      
                      
                      ; ***********************
                      ; *  Pre-Fill and Cycle 
                      ; *  the Display Buffer
                      ; ***********************
                      
203E  7F2000                                  clr             var_ch                  ; character = 0
2041  7F2001                                  clr             var_at                  ; attribute = 0
2044  7F2002                                  clr             var_count               ; count = 0
2047  8E0400                                  ldx             #VIDEO_START    ; start of display buffer
204A                  1
204A  8C17FF                                  cmpx    #VIDEO_END              ; at the end of the buffer?
204D  2C1D                                    bge             2f                              ; yes, skip to the screen updates
204F  B62000                                  lda             var_ch                  ; load the current character
2052  F62001                                  ldb             var_at                  ; load the current attribute
2055  ED81                                    std             ,x++                    ; store both character and attribute
2057  7C2000                                  inc             var_ch                  ; next character
205A  7C2002                                  inc             var_count               ; increment count
205D  B62002                                  lda             var_count               ; load the count
2060  8111                                    cmpa    #17                             ; compare the count with this amount
2062  2DE6                                    blt             1b                              ; loop if count lower than
2064  7C2001                                  inc             var_at                  ; next attribute
2067  7F2002                                  clr             var_count               ; clear the count
206A  20DE                                    bra             1b                              ; resume the loop
                      
                                              ; INCREMENT THE SCREEN BUFFER
206C                  2
206C  8E0400                                  ldx             #VIDEO_START    ; start beginning of video buffer
206F                  4
206F  8C17FF                                  cmpx    #VIDEO_END              ; until the end of the video buffer
2072  2C06                                    bge             3f                              ; restart when past the end
2074  6C80                                    inc             ,x+                             ; increment character
2076  6C80                                    inc             ,x+                             ; increment the attribute
2078  20F5                                    bra             4b                              ; loop until done
207A                  3
                      
                      
                                              ; INCREMENT THE EXTENDED SCREEN BUFFER
207A  8E0000                                  ldx             #0
207D                  8                       
207D  BF180C                                  stx             GFX_EXT_ADDR
2080  7C180E                                  inc             GFX_EXT_DATA
2083  3001                                    leax    1,x
2085  8C0280                                  cmpx    #640            ;#$0800
2088  26F3                                    bne             8b
                      
                                              ; TOGGLE THE BACKBUFFER
208A  B61801                                  lda             GFX_FLAGS       ; load current backbuffer
208D  8820                                    eora    #$20            ; toggle it
208F  B71801                                  sta             GFX_FLAGS       ; save the backbuffer
                      
                                              ; COLOR CYCLE THE MOUSE CURSOR
2092  8604                                    lda             #4
2094  B71818                                  sta             CSR_PAL_INDX
2097  FC1819                                  ldd             CSR_PAL_DATA
209A  C300A0                                  addd    #$00a0
209D  FD1819                                  std             CSR_PAL_DATA            
                      
                                              ; INCREMENT THE CYCLE COUNTER
20A0  7C2004                                  inc             var_cycle       ; increment the cycle counter
20A3  B62004                                  lda             var_cycle
20A6  8120                                    cmpa    #num_cycles             ; max cycles yet?
20A8  2323                                    bls             continue        ; nope, continue with the main loop
20AA  7F2004                                  clr             var_cycle       ; reset the cycle count
                      
                                              ; MODE CHANGES
20AD                  6
20AD  F62005                                  ldb             var_mode_index
20B0  7C2005                                  inc             var_mode_index
20B3  8E20E5                                  ldx             #mode_data
20B6  A685                                    lda             b,x
20B8  81FF                                    cmpa    #$ff
20BA  270C                                    beq             5f
20BC  B61801                                  lda             GFX_FLAGS
20BF  84F0                                    anda    #$f0
20C1  AA85                                    ora             b,x
20C3  B71801                                  sta             GFX_FLAGS
20C6  2005                                    bra             continue
20C8                  5       
20C8  7F2005                                  clr             var_mode_index
20CB  20E0                                    bra             6b
20CD                  continue
                                              ; WAS [ESCAPE] PRESSED
20CD  B61A2B                                  lda             CHAR_Q_LEN
20D0  279A                                    beq             2b
                      
                                              ; check for ESCAPE
20D2  B61A2D                                  lda             CHAR_POP
20D5  811B                                    cmpa    #$1b            ; [ESCAPE]
20D7  2693                                    bne             2b
                      
                                              ; RESTORE THE MOUSE CURSOR COLOR
20D9  8604                                    lda             #4
20DB  B71818                                  sta             CSR_PAL_INDX
20DE  FC2006                                  ldd             var_mouse_color
20E1  FD1819                                  std             CSR_PAL_DATA
                      
20E4  39              done            rts
                                      
                      ; ////////////////////////////////////////////////////
                      
                      ;mode_data      fcb             $08, $08, $08, $08, $08, $08, $08, $08
                      ;                       fcb             $08, $08, $08, $08, $08, $08, $08, $08
                      
20E5  0001020304050607 mode_data       fcb             $00, $01, $02, $03, $04, $05, $06, $07
20ED  08090A0B0C0D0E0F                         fcb             $08, $09, $0a, $0b, $0c, $0d, $0e, $0f
                      
20F5  FF                                      fcb             $ff
