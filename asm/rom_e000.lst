                      ; ****************
                      ; * ROM_E000.asm *
                      ; ****************
                              
                      
                      ; system call macro to support the Warte variant 
                      ;               of the MC6809e, the 6809w. This replaces
                      ;               the SWI3 instruction with the SYS #n OS9 
                      ;               style system call instruction.
                      SYS             macro
                                      SWI3
                                      fcb             \1              
                                      endm
                                              
                      
                                              
                      
                      ; **************
                      ; * MEMORY MAP *
                      ; **************
0000                                                  org     $0000
                                                      
0000  E020            SOFT_RESET      fdb     do_RESET        ; Software RESET Vector
0002  E00B            SOFT_NMI        fdb     do_NMI          ; Software NMI Vector
0004  E00E            SOFT_SWI        fdb     do_SWI          ; Software SWI Vector
0006  E011            SOFT_IRQ        fdb     do_IRQ          ; Software IRQ Vector
0008  E014            SOFT_FIRQ       fdb     do_FIRQ         ; Software FIRQ Vector
000A  E017            SOFT_SWI2       fdb     do_SWI2         ; Software SWI2 Vector
000C  E01A            SOFT_SWI3       fdb     do_SWI3         ; Software SWI3 Vector
000E  E01D            SOFT_RSRVD      fdb     do_RSRV         ; Software Motorola Reserved Vector
                      
0010  E078            EXEC_VECTOR             fdb             reset
                      
                      
0012                                          INCLUDE "mem_map.asm"
                      ;  **********************************************
                      ;  * Allocated 64k Memory Mapped System Symbols *
                      ;  **********************************************
                      
                      ;  Zero-Page Kernal Variables:
0010                  SYSTEM_VARS     equ     $0010   ; start kernal vectors and variables
                      
                      ;  Stack Frames:
0100                  U_STK_BTM       equ     $0100   ; 256 bytes default user stack space
0200                  U_STK_TOP       equ     $0200   ; User Stack initial address
0200                  S_STK_BTM       equ     $0200   ; 512 bytes default system stack space
0400                  S_STK_TOP       equ     $0400   ; System Stack initial address
                      
                      ;  Video Buffer Memory (target = $0400):
0400                  VIDEO_START     equ     $0400   ; Start of 5KB Video Buffer Memory
17FF                  VIDEO_END       equ     $17ff   ; Last Byte of 5KB Video Buffer Memory
                      
                      ;  Graphics Hardware Registers:
1800                  GFX_BEGIN       equ     $1800   ; start of graphics hardware registers
1800                  GFX_FLAGS       equ     $1800   ; (Byte) gfx system flags:
                                                      ;      bit 7: VSYNC
                                                      ;      bit 6: backbuffer enable
                                                      ;      bit 5: swap backbuffers (on write)
                                                      ;      bit 4: reserved
                                                      ;      bits 2-3 = 'Background' graphics modes (20KB buffer)
                                                      ;          0) NONE (forced black background)
                                                      ;          1) Tiled 16x16 mode
                                                      ;          2) Overscan Tile 16x16 mode
                                                      ;          3) 128x80 x 256-Colors
                                                      ;      bits 0-1 = 'Foreground' graphics modes (5KB buffer)
                                                      ;          0) 256x160 x 2-Color (with disable flag)
                                                      ;          1) Glyph Mode (32x20 text)
                                                      ;          2) Glyph Mode (64x40 text)
                                                      ;          3) 128x80 x 16-Color
1801                  GFX_AUX equ     $1801   ; (Byte) gfx auxillary/emulation flags:
                                                      ;      bit 7: 1:fullscreen / 0:windowed
                                                      ;      bit 6: reserved
                                                      ;      bit 5: reserved
                                                      ;      bit 4: reserved
                                                      ;      bit 3: reserved
                                                      ;      bit 0-2: monitor display index (0-7)
1802                  GFX_TIMING_W    equ     $1802   ; (Word) horizontal timing
1804                  GFX_TIMING_H    equ     $1804   ; (Word) vertical timing
1806                  GFX_PAL_INDX    equ     $1806   ; (Byte) gfx palette index (0-15)
1807                  GFX_PAL_DATA    equ     $1807   ; (Word) gfx palette color bits RGBA4444
                      
                      ;  Paged Foreground Graphics Mode Hardware Registers:
1809                  GFX_FG_BEGIN    equ     $1809   ; start of paged foreground gfxmode registers
1809                  GFX_FG_WDTH     equ     $1809   ; (Byte) Foreground Unit Width-1
180A                  GFX_FG_HGHT     equ     $180a   ; (Byte) Foreground Unit Height-1
180A                  GFX_FG_END      equ     $180a   ; end of paged foreground gfxmode registers
                      
                      ;  Paged Background Graphics Mode Hardware Registers:
180B                  GFX_BG_BEGIN    equ     $180b   ; start of paged background gfxmode registers
180B                  GFX_EXT_ADDR    equ     $180b   ; (Word) 20K extended graphics addresses
180D                  GFX_EXT_DATA    equ     $180d   ; (Byte) 20K extended graphics RAM data
180D                  GFX_BG_END      equ     $180d   ; end of paged background gfxmode registers
                      
                      ;  Mouse Cursor Hardware Registers:
180E                  CSR_BEGIN       equ     $180e   ; start of mouse cursor hardware registers
180E                  CSR_XPOS        equ     $180e   ; (Word) horizontal mouse cursor coordinate
1810                  CSR_YPOS        equ     $1810   ; (Word) vertical mouse cursor coordinate
1812                  CSR_XOFS        equ     $1812   ; (Byte) horizontal mouse cursor offset
1813                  CSR_YOFS        equ     $1813   ; (Byte) vertical mouse cursor offset
1814                  CSR_SIZE        equ     $1814   ; (Byte) cursor size (0-15) 0:off
1815                  CSR_SCROLL      equ     $1815   ; (Signed) MouseWheel Scroll: -1, 0, 1
1816                  CSR_FLAGS       equ     $1816   ; (Byte) mouse button flags:
                                                      ;      bits 0-5: button states
                                                      ;      bits 6-7: number of clicks
1817                  CSR_PAL_INDX    equ     $1817   ; (Byte) mouse cursor color palette index (0-15)
1818                  CSR_PAL_DATA    equ     $1818   ; (Word) mouse cursor color palette data RGBA4444
181A                  CSR_BMP_INDX    equ     $181a   ; (Byte) mouse cursor bitmap pixel offset
181B                  CSR_BMP_DATA    equ     $181b   ; (Byte) mouse cursor bitmap pixel index color
181B                  CSR_END equ     $181b   ; end of mouse cursor hardware registers
                      
                      ;  Debugger Hardware Registers:
181C                  DBG_BEGIN       equ     $181c   ; Start of Debugger Hardware Registers
181C                  DBG_BRK_ADDR    equ     $181c   ; (Word) Address of current breakpoint
181E                  DBG_FLAGS       equ     $181e   ; (Byte) Debug Specific Hardware Flags
                                                      ;      bit 7: Debug Enable
                                                      ;      bit 6: Single Step Enable
                                                      ;      bit 5: clear all breakpoints
                                                      ;      bit 4: Toggle Breakpoint at DEBUG_BRK_ADDRESS
                                                      ;      bit 3: FIRQ  (on low to high edge)
                                                      ;      bit 2: IRQ   (on low to high edge)
                                                      ;      bit 1: NMI   (on low to high edge)
                                                      ;      bit 0: RESET (on low to high edge)
181E                  DBG_END equ     $181e   ; End of the Debugger Hardware Registers
                      
                      
181F                  GFX_END equ     $181f   ; end of the GFX Hardware Registers
                      
                      ;  File I/O Hardware Registers:
181F                  FIO_BEGIN       equ     $181f   ; start of file i/o hardware registers
181F                  FIO_ERR_FLAGS   equ     $181f   ; (Byte) file i/o system flags:
                                                      ;      bit 7:   file not found
                                                      ;      bit 6:  end of file
                                                      ;      bit 5:   buffer overrun
                                                      ;      bit 0-4: not yet assigned
1820                  FIO_COMMAND     equ     $1820   ; (Byte) OnWrite - command to execute
                                                      ;      $00 = Reset/Null
                                                      ;      $01 = Open/Create Binary File for Reading
                                                      ;      $02 = Open/Create Binary File for Writing
                                                      ;      $03 = Open/Create Binary File for Append
                                                      ;      $04 = Close File
                                                      ;      $05 = Read Byte
                                                      ;      $06 = Write Byte
                                                      ;      $07 = Load Hex Format File
                                                      ;      $08 = Write Hex Format Line
                                                      ;      $09 = Get File Length (FIO_BFRLEN = file length
                                                      ;      $0A = Load Binary File (read into FIO_BFROFS - FIO_BFROFS+FIO_BFRLEN)
                                                      ;      $0B = Save Binary File (wrote from FIO_BFROFS to FIO_BFROFS+FIO_BFRLEN)
                                                      ;      $0C = (not yet designed) List Directory
                                                      ;      $0D = Make Directory
                                                      ;      $0E = Change Directory
                                                      ;      $0F = Rename Directory
                                                      ;      $10 = Remove Directory
                                                      ;      $11 = Delete File
                                                      ;      $12 = Rename file
                                                      ;      $13 = Copy File
                                                      ;      $14 = Seek Start
                                                      ;      $15 = Seek Current
                                                      ;      $16 = Seek End
1821                  FIO_HANDLE      equ     $1821   ; (Byte) file handle or ZERO
1822                  FIO_BFROFS      equ     $1822   ; (Word) start of I/O buffer
1823                  FIO_BFRLEN      equ     $1823   ; (Word) length of I/O buffer
1825                  FIO_SEEKOFS     equ     $1825   ; (Word) seek offset
1827                  FIO_FILEPATH    equ     $1827   ; (Char Array 256) file path and argument buffer
1927                  FIO_END equ     $1927   ; end of file i/o hardware registers
                      
                      ;  Keyboard Hardware Registers:
1928                  KEY_BEGIN       equ     $1928   ; start of keyboard hardware registers
1928                  KEY_TEMP1       equ     $1928   ; (Byte) temporary keyboard register
1929                  KEY_TEMP2       equ     $1929   ; (Byte) secondary keyboard register
192A                  KEY_END equ     $192a   ; end of keyboard hardware registers
                      
                      ;  Reserved Hardware:
192B                  RESERVED_HDW    equ     $192b   ; Reserved 1744 bytes ($192B - $1FFB)
                      
                      ;  Memory Bank Selects (16MB):
1FFC                  RAMBANK_SEL_1   equ     $1ffc   ; (Word)Indexes 65536 x 8kb banks
1FFE                  RAMBANK_SEL_2   equ     $1ffe   ; (Word)Indexes 65536 x 8kb banks
                      
                      ;  Standard Usable (from FAST static 32KB) RAM:
2000                  RAM_START       equ     $2000   ; Begin System RAM (32k)
9FFF                  RAM_END equ     $9fff   ; End System RAM
                      
                      ;  Switchable RAM Banks (from SLOW external serial 16MB RAM chip):
A000                  RAM_BANK_1      equ     $a000   ; switched 8KB ram bank 1
C000                  RAM_BANK_2      equ     $c000   ; switched 8KB ram bank 2
                      
                      ;  Bios Kernal ROM:
E000                  BIOS_ROM        equ     $e000   ; Begin BIOS Kernal ROM (8KB)
                      
                      
                      
                      ; ***************************************
                      ; * Read Only Sytem KERNAL ROM          *
                      ; ***************************************
                                            
                       
0012                  SECTION.CODE
E000                                          org     $E000  
                                  ;* Power On Initialization            
E000                  ROM_ENTRY   
E000  CE0200                                  LDU             #U_STK_TOP              ; top of user stack     
E003  10CE0400                                LDS     #S_STK_TOP              ; top of stack space            
E007  6E9F0000                    JMP     [SOFT_RESET]      
                      
                                  
                                  ;* NMI Vector Handler                     
E00B  7EE023          do_NMI      JMP just_rti
                                  
                                  ;* SWI Vector Handler (do_SWI)   
E00E  7EE023          do_SWI          JMP just_rti
                      
                                  ;* IRQ Vector Handler         
E011  7EE023          do_IRQ      JMP just_rti
                      
                                  ;* FIRQ Vector Handler         
E014  7EE023          do_FIRQ     JMP just_rti
                      
                                  ;* SWI2 Vector Handler         
E017  7EE023          do_SWI2     JMP just_rti
                      
                                  ;* SWI3 Vector Handler         
E01A  7EE023          do_SWI3     JMP just_rti
                      
                                  ;* Reserved Vector Handler
E01D  7EE078          do_RSRV     JMP reset
                      
                                  ;* Reset Vector Handler         
E020  7EE078          do_RESET    JMP reset
                                  
                      ;********************
                      ;* RESET
                      ;**************************                     
                                              
                      ; NOTES:  
                      ;
                      ;                       SYNC still needs to be implemented along with NMI, IRQ, and FIRQ handlers
                      
E023                  just_rti        
E023  3B                                      rti 
                      
E024  2E2F61736D2F746573742E68657800 test_file       fcn             "./asm/test.hex"
                      
E033  54776F2D504920526574726F203638303900 prompt_msg1     fcn             "Two-PI Retro 6809"
E045  42494F53204B45524E454C20762E302E303100 prompt_msg2     fcn             "BIOS KERNEL v.0.01"
E058  436F707972696768742032303233206279204A61792046617269657300 prompt_msg3 fcn         "Copyright 2023 by Jay Faries"
E075  4F4B00          prompt_ready fcn        "OK"
                      
E078                  reset           
E078  BDE0DA                                  jsr             test_load_hex
                      
                      
                              ; load the default graphics mode
E07B  8602                                    lda             #$02
E07D  B71800                                  sta             GFX_FLAGS
                      
                              ; clear screen
E080  8E0400                                  ldx             #VIDEO_START
E083  8620                                    lda             #' '
E085  C6A2                                    ldb             #$a2
E087                  1               
E087  ED81                                    std             ,x++
E089  8C17FF                                  cmpx    #VIDEO_END
E08C  23F9                                    bls             1b      
                      
                              ; first prompt line
E08E  108EE033                                ldy             #prompt_msg1
E092  8E0400                                  ldx             #VIDEO_START
E095  BDE0D1                                  jsr             prt_line
                      
E098  108EE045                                ldy             #prompt_msg2
E09C  8E0480                                  ldx             #VIDEO_START + 128
E09F  BDE0D1                                  jsr             prt_line
                      
E0A2  108EE058                                ldy             #prompt_msg3
E0A6  8E0500                                  ldx             #VIDEO_START + 256
E0A9  BDE0D1                                  jsr             prt_line
                      
E0AC  108EE075                                ldy             #prompt_ready
E0B0  8E0600                                  ldx             #VIDEO_START + 512
E0B3  BDE0D1                                  jsr             prt_line
                      
                              ; simply flash a cursor
E0B6  8E0680                                  ldx             #VIDEO_START + 640
E0B9  8620                                    lda             #' '    ;$8f
E0BB                  1
                                              ; update the cursor
E0BB  A784                                    sta             0,x
                      
                                              ; increment bg cursor color with black fg
E0BD  E601                                    ldb             1,x
E0BF  CB01                                    addb    #$01            ;$10
E0C1  C40F                                    andb    #$0F            ;$f0
E0C3  E701                                    stb             1,x
                      
                                              ; delay
E0C5  108E4000                                ldy             #$4000
E0C9  313F            2                       leay    -1, y
E0CB  26FC                                    bne             2b
                      
E0CD  20EC                                    bra             1b
                      
                      
                      
                      
                      ;2
                      ;                       lda             ,y+
                      ;                       beq             3f
                      ;                       sta             ,x++
                      ;                       bra             2b
                      ;3              
                      
E0CF  20FE            done            bra             done
                      
                      
                      ; ** Subroutines ****************************
                      
E0D1                  prt_line        
E0D1                  2
E0D1  A6A0                                    lda             ,y+
E0D3  2704                                    beq             3f
E0D5  A781                                    sta             ,x++
E0D7  20F8                                    bra             2b
E0D9                  3               
E0D9  39                                      rts
                                      
                      
                      
                      ; **** SUBROUTINES ***************************************************
                      
                      
                      ; FILE SYSTEM TESTS:
                      
E0DA                  test_load_hex
                                              ; load "test.hex"
E0DA  8EE024                                  ldx             #test_file              ; fetch the filename
E0DD  108E1827                                ldy             #FIO_FILEPATH   ; fetch the filename hardware register storage
E0E1                  1
E0E1  A680                                    lda             ,x+                             ; copy a character from the source filename
E0E3  A7A0                                    sta             ,y+                             ; store it in the hardware register
E0E5  26FA                                    bne             1b                              ; keep looping until null-termination
                      
E0E7  8607                                    lda             #$07                    ; command: LoadHex
E0E9  B71820                                  sta             FIO_COMMAND             ; executre the command
E0EC  B6181F                                  lda             FIO_ERR_FLAGS   ; load the errors flag
E0EF  8180                                    cmpa    #$80                    ; test for bit: file not found?
E0F1  2704                                    beq             1f                              ; dont call the sub if it wasnt loaded
E0F3  AD9F0010                                jsr             [$0010]                 ; call the loaded subroutine
E0F7                  1
E0F7  39                                      rts
                      
                      
                      
                      
                      ; ***********************************************************
                      
                      
                      ; interrupt vectors
FFF0                                                  org  $fff0
FFF0  E01D            HARD_RSRVD      fdb  do_RSRV    ; Motorola RESERVED Hardware Interrupt Vector
FFF2  E01A            HARD_SWI3       fdb  do_SWI3    ; SWI3 Hardware Interrupt Vector
FFF4  E017            HARD_SWI2       fdb  do_SWI2    ; SWI2 Hardware Interrupt Vector
FFF6  E014            HARD_FIRQ       fdb  do_FIRQ    ; FIRQ Hardware Interrupt Vector
FFF8  E011            HARD_IRQ        fdb  do_IRQ     ; IRQ Hardware Interrupt Vector
FFFA  E00E            HARD_SWI        fdb  do_SWI     ; SWI/SYS Hardware Interrupt Vector
FFFC  E00B            HARD_NMI        fdb  do_NMI     ; NMI Hardware Interrupt Vector
FFFE  E000            HARD_RESET      fdb  ROM_ENTRY  ; RESET Hardware Interrupt Vector
                      
0000                                          END
